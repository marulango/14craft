<!DOCTYPE html>
<html>
<head>
  <title>FFXIV - Demon Fam Mats List</title>
  <link rel="stylesheet" type="text/css" href="css/style.css">
  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://use.fontawesome.com/dad29fea0c.js"></script>
</head>
<body>
  <div class="container">
    <div class="row top-3">
      <div class="col-12">
        <h1>Famfrit Fam Materials List</h1>
      </div>
      <div class="col-12 top-3">
        <label for="autocomplete">Search item: </label>
        <input id="autocomplete" placeholder="Type to start searching…">
      </div>
      <div class="col-12">
        <ul class="autocompleteContent top-3"><!-- Magic will append here --></ul>
      </div>
    </div>
  </div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="//code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script type="text/javascript">
    var baseURL = "https://api.xivdb.com"
    var $target = $('.autocompleteContent')
   
    var $ul = document.createElement('div')

    $(document).on('click', '.remove', function(e){
      $(e.target).parent().parent().empty()
    })


    $.getJSON( `${baseURL}/recipe`, function( data ) {
      var name = data.map(item => ({ label: item.name, value: item.name, id: item.id }))

      $( "#autocomplete" ).autocomplete({
        source: (request, response) => {
          var matcher = new RegExp( "^" + $.ui.autocomplete.escapeRegex( request.term ), "i" );
          var found = name.filter(item => matcher.test(item.label));
          response(found);
        },
        select: (event, ui) => {

          $.getJSON(`${baseURL}/recipe/${ui.item.id}`, function(data) {
            var itemName = data.name
            itemClassName = itemName.replace(/\s+/g, '-').replace(/'/g, '').toLowerCase();
            console.log(itemClassName);
            $target.prepend('<div class="material-item '+itemClassName+'"></div>')
            $('.'+itemClassName).append('<div class="itemName"><button class="remove"></button><h2>'+ itemName + '</h2></div>')
            $('.'+itemClassName).append('<div class="matsHeader row"><div class="col-8"><label>Material</label></div><div class="col-4"><label>QTY</label></div></div>') //this could be a variable…?

            var craftableTree = data.tree
            if(craftableTree.length > 0 == true) {
              for(var i = 0; i < craftableTree.length; i++) {
                $('.'+itemClassName).append('<li class="row"><div class="col-8"><p>'+ craftableTree[i].name+'</p></div><div class="col-4"><p>'+ craftableTree[i].quantity +'</p></div></li>' ) //this can be much more legible. but idc about that rn
              }
            }
          })
        }
      });
      
    });

    //TODO: Clean this sloppy code, you can do better. 
  </script>
</body>
</html>